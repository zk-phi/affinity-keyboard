# AFFINITY Keyboard

※試作品です (TODO 参照)

![front](images/front.jpg)

![components](images/components.jpg)

7 バンドスペアナ IC を搭載し、音声入力に応じて LED のパターンを変化させるなどのギミックを実装できるサブキーボードです。

TRRS ジャックが２つ生えているので、片方に音楽プレーヤーなどの出力を、他方にイヤホンなどを接続して使用します。

MX スイッチ、 Choc スイッチに対応しています。

## 動画

レベルメーター風

- https://twitter.com/zk_phi/status/1271797216508669954

パリピモード (ビートに合わせて演出)

- https://twitter.com/zk_phi/status/1272497990968565760

## パーツ

- メイン基板
- ボトムプレート
- ProMicro カバー
- いつもの
  - ダイオード 1N4148w x16
  - 2 ピンタクトスイッチ x1
  - コンスルー付き ProMicro x1
- LED
  - SK6812mini x16
  - チップコンデンサ 0.1uF (2012 Metrics) x16
- スペアナ周辺回路
  - スペアナ IC MSGEQ7 x1
  - チップコンデンサ 0.1uF (2012 Metrics) x3
  - コンデンサ 33pF (2.5mm ピッチ) x1
  - チップ抵抗 220K (2012 Metrics) x1
  - チップ抵抗 22K (2012 Metrics) x2
  - TRRS ジャック MJ-4PP-9 x2
- キースイッチ
  - MX 互換 or Choc x16
    - 初期の Choc クリッキーにあった追加のピンは刺さりません
- ネジ類
  - M2 スペーサ 5mm x5
  - M2 スペーサ 7mm x2
    - コンスルーの足を切れば 5mm でも ok (その方が個人的には好き)
  - M2 ネジ 3~4mm x14
  - ゴム足 4 個

## TODO

今のバージョンにはいくつか改善の余地があります。

### 凡ミス系

- PCB マウントのピンが若干ゆるく、 choc スイッチの位置決めがやや難しい
  - 個体差かも？

- ２つの TRRS ジャックの間が思ったより狭く、太いプラグは２本刺さらない
  - 写真参照

- Pro Micro カバーをつけてしまうとリセットスイッチが押せない (!!)
  - キーの組み合わせでリセットをかけられるようにして対応

### 音量調節問題

どれくらいの音量に反応させるかはファームウェア側でも設定できますが、とはいえ入力が小さいと精度がかなり落ちます。そのため、キーボードに入力する音声は一般的なポータブルプレーヤーの MAX 近い音量が推奨になります。

実用するには、

```
プレーヤー
| (音量大)
このキーボード
|
減衰器
| (音量小)
イヤホン
```

のようにイヤホンへの入力だけを減衰するか、逆に

```
プレーヤー
|
+-- アンプ --- (音量大) このキーボード
|
+-- (音量小) イヤホン
```

のようにこのキーボードへの入力だけを増幅する感じになると思います。

減衰器は適当な (どれくらい減衰させたいかによる) 大きさの抵抗を探してくるだけで簡単に作れるほか、市販でも「抵抗入りケーブル」「ボリューム付きケーブル」などの名前で売られています。

私は以下のような回路をブレッドボードに仮組みして使っています。

```
Keyboard         ->         Earphone

Lout --- 30 Ohm ---+------- Lin
                   |
                 10 Ohm
                   |
Rout --- 30 Ohm ---|---+--- Rin
                   |   |
                   | 10 Ohm
                   |   |
 GND --------------+---+--- GND
```

ゆくゆくはこのキーボードに簡単なアンプ回路を内蔵するべきなのかなあと思っています。

### ノイズ問題

LED がたくさん光っていると、音声に謎のノイズが乗ります。

試してみたこと：

- 以前近いコンセプトの試作品を作った時は LED にパスコンがなかったのでパスコンをつけた、マシにはなったのかもしれない (?) けど解決にはならず
- 相手のデバイス (オーディオプレーヤーなど) と繋いでいる時だけ問題の音が出る
- LED 光らせている時だけ問題の音が出る
- イヤホン出力の GND やオーディオ入力の GND にフェライトビーズを挟んで無理やり分離しようとしてみたけど意味なかった

現状では LED をノイズが気にならない程度の光量に抑えて対応しています。

フィードバック・アドバイス・プルリク歓迎です。むしろ誰か助けて。

## 組み立て

![back](images/back.jpg)

- 裏面に実装する表面実装部品 (ダイオード、チップコンデンサ、 LED) を実装します
  - チップコンを最初につけるのが個人的にはらくでした
  - ダイオードはコの字の印がカソード、 LED はコの字の印が Vcc です
  - LED の実装順は最上段の Pro Micro 側から反対側へ (写真では左から右)
  - ２段目以降も同様

- ファームを焼いた Pro Micro をコンスルーで差し込み動作テストをします
  - `zk-phi/qmk_firmware` にあります: `make handrwired/affinity:default:avrdude`

- おもて面に実装する部品を背の低いものから実装します
  - チップ抵抗、チップコンデンサ、スペアナ IC、リセットスイッチ、コンデンサ、 TRRS ジャック

- キースイッチを実装します

![spacers](images/spacers.jpg)

- ボトムプレートに５つ、メイン基板に２つスペーサーを立てます

- ボトムプレートにメイン基板を取り付け、メイン基板に Pro Micro カバーを取り付けます
  - この順でないと取り付けられません (これも要改善かも)

- ゴム足を貼れば完成
